<wxs module="dateHelper">
	// 检查选中的日期是否在卡片的日期数据范围内
	var isDateInRange = function(selectedStart, selectedEnd, daysWithData) {
		if (!daysWithData || !daysWithData.length) return false;
		if (!selectedStart || !selectedEnd) return false;

		// 检查 daysWithData 中是否有任何日期在选中的范围内
		for (var i = 0; i < daysWithData.length; i++) {
			var day = daysWithData[i];
			if (day >= selectedStart && day <= selectedEnd) {
				return true;
			}
		}
		return false;
	};

	// 截断文本，超过指定长度显示省略号
	var truncateText = function(text, maxLen) {
		if (!text) return '';
		maxLen = maxLen || 15;
		if (text.length <= maxLen) return text;
		return text.substring(0, maxLen) + '...';
	};

	// 检查课程是否已开始（当前时间 > 课程开始时间）
	// day: "2026-01-28", timeStart: "14:00"
	var isClassStarted = function(day, timeStart) {
		if (!day || !timeStart) return false;

		// 获取当前时间
		var now = getDate();
		var nowYear = now.getFullYear();
		var nowMonth = now.getMonth() + 1;
		var nowDay = now.getDate();
		var nowHour = now.getHours();
		var nowMinute = now.getMinutes();

		// 解析课程日期 "2026-01-28"
		var dateParts = day.split('-');
		var classYear = parseInt(dateParts[0]);
		var classMonth = parseInt(dateParts[1]);
		var classDay = parseInt(dateParts[2]);

		// 解析课程开始时间 "14:00"
		var timeParts = timeStart.split(':');
		var classHour = parseInt(timeParts[0]);
		var classMinute = parseInt(timeParts[1]) || 0;

		// 比较日期
		if (nowYear > classYear) return true;
		if (nowYear < classYear) return false;
		if (nowMonth > classMonth) return true;
		if (nowMonth < classMonth) return false;
		if (nowDay > classDay) return true;
		if (nowDay < classDay) return false;

		// 同一天，比较时间
		if (nowHour > classHour) return true;
		if (nowHour < classHour) return false;
		if (nowMinute >= classMinute) return true;

		return false;
	};

	module.exports = {
		isDateInRange: isDateInRange,
		truncateText: truncateText,
		isClassStarted: isClassStarted
	};
</wxs>

<template name="calendarIndexTpl">
	<!-- 周滑条始终显示在顶部 -->
	<view class="plan-date">
		<cmpt-calendar-scroll hasDays="{{hasDays}}" bind:click="bindClickCmpt" mode="week" />
	</view>

	<!-- 加载状态显示在日历下方 -->
	<view wx:if="{{isLoad===null}}" class="margin-top load notexist text-l load-project"></view>
	<view wx:if="{{isLoad===false}}" class="margin-top load loading text-l load-project"></view>

	<view class="main {{skin && skin.IS_SUB?'sub-margin-bottom':''}}" wx:if="{{isLoad}}">
		<view class="list padding-project">
			<view wx:if="{{list===null}}" class="load loading text-l text-grey"></view>
			<text wx:elif="{{list.length==0}}" class="no-project icon-emoji text-l text-grey"> 本日没有可预约的项目哦~</text>

			<!-- 新的卡片样式 - 左中右三个区域 + 侧边指示条 -->
			<view class="meet-card-horizontal category-{{item.typeId}} {{dateHelper.isClassStarted(item.day, item.timeStart) ? 'card-started' : ''}}" wx:for="{{list}}" wx:key="_id" bindtap="{{dateHelper.isClassStarted(item.day, item.timeStart) ? '' : 'url'}}" data-url="../../meet/detail/meet_detail?id={{item.meetId}}&day={{item.day}}&timeStart={{item.timeStart}}&timeEnd={{item.timeEnd}}">

				<!-- 左侧区域：日期 + 头像 -->
				<view class="card-left-section">
					<view class="date-info">
						<text class="date-text">{{item.dayText}}</text>
						<text class="weekday-text">{{item.weekDay}}</text>
					</view>
					<view class="avatar-wrapper">
						<image class="instructor-avatar"
							   src="{{item.instructorAvatar || item.pic}}"
							   mode="aspectFill"
							   lazy-load="{{true}}" />
					</view>
				</view>

				<!-- 中间区域：标签 + 时长 + 导师 + 人数 + 开课提示 -->
				<view class="card-middle-section">
					<!-- 分类标签 -->
					<view class="category-tag category-tag-{{item.typeId}}" wx:if="{{item.typeName}}">
						{{item.typeName}}
					</view>

					<!-- 时间段 + 时长 -->
					<view class="time-duration">
						<text class="time-range">{{item.timeStart}}-{{item.timeEnd}}</text>
						<text class="duration">{{item.duration}}</text>
					</view>

					<!-- 导师名字 -->
					<view class="instructor-info">
						<text class="instructor-label">导师：</text>
						<text class="instructor-name">{{item.instructorName}}</text>
					</view>

					<!-- 课程信息 - 直接显示文字，点击查看完整内容 -->
					<view class="course-info-text-row" wx:if="{{item.courseInfo}}" catchtap="bindShowCourseInfo" data-info="{{item.courseInfo}}" data-title="{{item.title || item.typeName}}">
						<text class="course-info-preview">{{dateHelper.truncateText(item.courseInfo, 18)}}</text>
					</view>

					<!-- 预约人数 -->
					<view class="booking-info">
						<text class="booking-count">已约{{item.bookedCount}}/{{item.maxCount}}人</text>
					</view>

					<!-- 开课提示 -->
					<view class="class-notice">
						<text class="notice-text">满 2 人开课</text>
					</view>
				</view>

				<!-- 右侧区域：预约按钮 -->
				<view class="card-right-section">
					<button class="book-button {{dateHelper.isClassStarted(item.day, item.timeStart) ? 'button-started' : ''}}">{{dateHelper.isClassStarted(item.day, item.timeStart) ? '已开始' : '预约'}}</button>
				</view>
			</view>

		</view>
	</view>

	<!-- 课程信息弹窗 -->
	<view class="course-info-modal" wx:if="{{showCourseInfoModal}}" bindtap="bindCloseCourseInfo">
		<view class="modal-content" catchtap="preventClose">
			<view class="modal-header">
				<text class="modal-title">{{courseInfoTitle || '课程信息'}}</text>
				<view class="modal-close" bindtap="bindCloseCourseInfo">
					<text class="icon-close"></text>
				</view>
			</view>
			<scroll-view class="modal-body" scroll-y>
				<text class="course-info-text">{{courseInfoContent}}</text>
			</scroll-view>
		</view>
	</view>

</template>