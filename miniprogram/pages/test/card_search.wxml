<view class="container">
	<view class="header">
		<text class="title">å¡é¡¹æœç´¢</text>
	</view>

	<!-- å¿«é€Ÿè®¿é—® -->
	<view class="section quick-nav">
		<button class="btn-quick" bindtap="goCardStore">ğŸ›’ å•†åŸ</button>
		<button class="btn-quick" bindtap="goCardTest">âš™ï¸ ç®¡ç†</button>
	</view>

	<!-- æœç´¢åŒºåŸŸ -->
	<view class="section">
		<view class="section-title">ğŸ” æœç´¢æ–¹å¼</view>

		<!-- æœç´¢ç±»å‹é€‰æ‹© -->
		<view class="search-type-tabs">
			<view class="tab {{searchType === 'uniqueId' ? 'active' : ''}}" bindtap="switchSearchType" data-type="uniqueId">
				è¯†åˆ«ç æœç´¢
			</view>
			<view class="tab {{searchType === 'phone' ? 'active' : ''}}" bindtap="switchSearchType" data-type="phone">
				æ‰‹æœºå·æœç´¢
			</view>
		</view>

		<!-- è¯†åˆ«ç æœç´¢ -->
		<view wx:if="{{searchType === 'uniqueId'}}">
			<input
				class="search-input"
				placeholder="è¾“å…¥å¡é¡¹è¯†åˆ«ç  (å¦‚: UC12345678)"
				value="{{uniqueId}}"
				bindinput="onUniqueIdInput"
				maxlength="20"
			/>
			<button class="btn btn-primary" bindtap="searchByUniqueId" loading="{{searching}}">
				{{searching ? 'æœç´¢ä¸­...' : 'æœç´¢å¡é¡¹'}}
			</button>
			<view class="hint">é€šè¿‡å”¯ä¸€è¯†åˆ«ç å¿«é€ŸæŸ¥æ‰¾å¡é¡¹</view>
		</view>

		<!-- æ‰‹æœºå·æœç´¢ -->
		<view wx:if="{{searchType === 'phone'}}">
			<input
				class="search-input"
				placeholder="è¾“å…¥æ‰‹æœºå·"
				value="{{phone}}"
				bindinput="onPhoneInput"
				type="number"
				maxlength="11"
			/>
			<button class="btn btn-primary" bindtap="searchByPhone" loading="{{searching}}">
				{{searching ? 'æœç´¢ä¸­...' : 'æœç´¢ç”¨æˆ·'}}
			</button>
			<view class="hint">é€šè¿‡æ‰‹æœºå·æŸ¥æ‰¾ç”¨æˆ·çš„æ‰€æœ‰å¡é¡¹</view>
		</view>
	</view>

	<!-- æœç´¢ç»“æœ - è¯†åˆ«ç æœç´¢ -->
	<view wx:if="{{searchResult && searchType === 'uniqueId'}}" class="section">
		<view class="section-title">ğŸ“‹ å¡é¡¹è¯¦æƒ…</view>

		<!-- ç”¨æˆ·ä¿¡æ¯ -->
		<view class="user-info" wx:if="{{searchResult.user}}">
			<view class="info-row">
				<text class="label">ç”¨æˆ·å§“å</text>
				<text class="value">{{searchResult.user.USER_NAME || 'æœªè®¾ç½®'}}</text>
			</view>
			<view class="info-row">
				<text class="label">æ‰‹æœºå·</text>
				<text class="value">{{searchResult.user.USER_MOBILE}}</text>
			</view>
		</view>

		<!-- å¡é¡¹ä¿¡æ¯ -->
		<view class="card-detail" wx:if="{{searchResult.userCard}}">
			<view class="card-header">
				<text class="card-name">{{searchResult.userCard.USER_CARD_CARD_NAME}}</text>
				<view class="card-status status-{{searchResult.userCard.USER_CARD_STATUS}}">
					{{searchResult.userCard.USER_CARD_STATUS_DESC}}
				</view>
			</view>

			<!-- å”¯ä¸€è¯†åˆ«ç  -->
			<view class="card-unique-id">
				<text class="unique-id-label">è¯†åˆ«ç :</text>
				<text class="unique-id-value">{{searchResult.userCard.USER_CARD_UNIQUE_ID}}</text>
				<text class="copy-btn" bindtap="copyUniqueId" data-id="{{searchResult.userCard.USER_CARD_UNIQUE_ID}}">å¤åˆ¶</text>
			</view>

			<!-- å¡é¡¹æ•°æ® -->
			<view class="card-info">
				<view class="info-row">
					<view class="info-item">
						<text class="info-label">ç±»å‹</text>
						<text class="info-value">{{searchResult.userCard.USER_CARD_TYPE_DESC}}</text>
					</view>
					<view class="info-item" wx:if="{{searchResult.userCard.USER_CARD_TYPE === 1}}">
						<text class="info-label">å‰©ä½™æ¬¡æ•°</text>
						<text class="info-value times">{{searchResult.userCard.USER_CARD_REMAIN_TIMES}}</text>
					</view>
					<view class="info-item" wx:if="{{searchResult.userCard.USER_CARD_TYPE === 2}}">
						<text class="info-label">å‰©ä½™ä½™é¢</text>
						<text class="info-value balance">${{searchResult.userCard.USER_CARD_REMAIN_AMOUNT}}</text>
					</view>
				</view>
			</view>

			<!-- æ—¶é—´ä¿¡æ¯ -->
			<view class="card-footer">
				<text class="footer-text">å……å€¼æ—¶é—´: {{searchResult.userCard.USER_CARD_ADD_TIME}}</text>
				<text class="footer-text" wx:if="{{searchResult.userCard.USER_CARD_EXPIRE_TIME}}">
					è¿‡æœŸæ—¶é—´: {{searchResult.userCard.USER_CARD_EXPIRE_TIME}}
				</text>
			</view>

			<!-- æ“ä½œæŒ‰é’® -->
			<view class="action-buttons">
				<button class="btn-action btn-deduct" bindtap="adjustCard" data-type="deduct">æ‰£å‡</button>
				<button class="btn-action btn-add" bindtap="adjustCard" data-type="add">å¢åŠ </button>
				<button class="btn-action btn-records" bindtap="viewRecords">æŸ¥çœ‹è®°å½•</button>
			</view>
		</view>
	</view>

	<!-- æœç´¢ç»“æœ - æ‰‹æœºå·æœç´¢ -->
	<view wx:if="{{searchResult && searchType === 'phone'}}" class="section">
		<view class="section-title">ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯</view>

		<!-- ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ -->
		<view class="user-info" wx:if="{{searchResult.user}}">
			<view class="info-row">
				<text class="label">ç”¨æˆ·å§“å</text>
				<text class="value">{{searchResult.user.USER_NAME || 'æœªè®¾ç½®'}}</text>
			</view>
			<view class="info-row">
				<text class="label">æ‰‹æœºå·</text>
				<text class="value">{{searchResult.user.USER_MOBILE}}</text>
			</view>
		</view>

		<!-- æ±‡æ€»ä¿¡æ¯ -->
		<view class="summary-card">
			<view class="summary-title">æ±‡æ€»ä¿¡æ¯</view>
			<view class="summary-row">
				<view class="summary-item">
					<text class="summary-label">æ€»æ¬¡æ•°</text>
					<text class="summary-value">{{searchResult.totalTimes}}</text>
				</view>
				<view class="summary-item">
					<text class="summary-label">æ€»ä½™é¢</text>
					<text class="summary-value">${{searchResult.totalAmount || searchResult.totalBalance || 0}}</text>
				</view>
				<view class="summary-item">
					<text class="summary-label">å¡é¡¹æ•°é‡</text>
					<text class="summary-value">{{searchResult.cards ? searchResult.cards.total : 0}}</text>
				</view>
			</view>
			<!-- æ·»åŠ å¡é¡¹æŒ‰é’® -->
			<button class="btn-add-card" bindtap="showAddCardModal">+ æ·»åŠ å¡é¡¹</button>
		</view>

		<!-- å¡é¡¹åˆ—è¡¨ -->
		<view wx:if="{{searchResult.cards && searchResult.cards.list}}" class="card-list">
			<view class="section-title">ğŸ’³ ç”¨æˆ·å¡é¡¹åˆ—è¡¨</view>
			<view class="card-item" wx:for="{{searchResult.cards.list}}" wx:key="_id">
				<view class="card-header">
					<text class="card-name">{{item.USER_CARD_CARD_NAME}}</text>
					<view class="card-status status-{{item.USER_CARD_STATUS}}">
						{{item.USER_CARD_STATUS_DESC}}
					</view>
				</view>

				<!-- å”¯ä¸€è¯†åˆ«ç  -->
				<view class="card-unique-id">
					<text class="unique-id-label">è¯†åˆ«ç :</text>
					<text class="unique-id-value">{{item.USER_CARD_UNIQUE_ID}}</text>
					<text class="copy-btn" bindtap="copyUniqueId" data-id="{{item.USER_CARD_UNIQUE_ID}}">å¤åˆ¶</text>
				</view>

				<!-- å¡é¡¹æ•°æ® -->
				<view class="card-info">
					<view class="info-row">
						<view class="info-item">
							<text class="info-label">ç±»å‹</text>
							<text class="info-value">{{item.USER_CARD_TYPE_DESC}}</text>
						</view>
						<view class="info-item" wx:if="{{item.USER_CARD_TYPE === 1}}" bindtap="showRecordsSheet" data-index="{{index}}">
							<text class="info-label">å‰©ä½™</text>
							<text class="info-value times clickable">{{item.USER_CARD_REMAIN_TIMES}}æ¬¡</text>
						</view>
						<view class="info-item" wx:if="{{item.USER_CARD_TYPE === 2}}" bindtap="showRecordsSheet" data-index="{{index}}">
							<text class="info-label">å‰©ä½™</text>
							<text class="info-value balance clickable">${{item.USER_CARD_REMAIN_AMOUNT}}</text>
						</view>
					</view>
				</view>

				<!-- æ—¶é—´ -->
				<view class="card-footer">
					<text class="footer-text">{{item.USER_CARD_ADD_TIME}}</text>
				</view>

				<!-- æ“ä½œæŒ‰é’® -->
				<view class="action-buttons">
					<button class="btn-action btn-deduct" bindtap="adjustCardFromList" data-index="{{index}}" data-type="deduct">æ‰£å‡</button>
					<button class="btn-action btn-add" bindtap="adjustCardFromList" data-index="{{index}}" data-type="add">å¢åŠ </button>
					<button class="btn-action btn-delete" bindtap="deleteCardFromList" data-index="{{index}}">åˆ é™¤</button>
				</view>
			</view>

			<view wx:if="{{searchResult.cards.list.length === 0}}" class="empty-state">
				<text class="empty-icon">ğŸ“­</text>
				<text class="empty-text">è¯¥ç”¨æˆ·æš‚æ— å¡é¡¹</text>
			</view>
		</view>
	</view>

	<!-- ç©ºçŠ¶æ€ -->
	<view wx:if="{{!searchResult && hasSearched}}" class="section empty-state">
		<text class="empty-icon">ğŸ”</text>
		<text class="empty-text">æœªæ‰¾åˆ°ç›¸å…³ä¿¡æ¯</text>
	</view>

	<!-- è¿”å›æŒ‰é’® -->
	<view class="footer-nav">
		<button class="btn-nav" bindtap="goBack">â† è¿”å›æµ‹è¯•é¡µ</button>
	</view>

	<!-- ä½¿ç”¨è®°å½•å¼¹çª— -->
	<view class="modal-overlay" wx:if="{{showRecordsModal}}" bindtap="hideRecordsModal" catchtouchmove="preventTouchMove">
		<view class="modal-container" catchtap="preventClose" catchtouchmove="preventTouchMove">
			<view class="modal-header">
				<text class="modal-title">ä½¿ç”¨è®°å½•</text>
				<text class="modal-close" bindtap="hideRecordsModal">Ã—</text>
			</view>
			<scroll-view class="modal-content" scroll-y>
				<view wx:if="{{recordsList && recordsList.length > 0}}">
					<view class="record-item" wx:for="{{recordsList}}" wx:key="_id">
						<view class="record-row">
							<text class="record-label">æ—¶é—´</text>
							<text class="record-value">{{item.RECORD_ADD_TIME}}</text>
						</view>
						<view class="record-row">
							<text class="record-label">ç±»å‹</text>
							<text class="record-value">{{item.RECORD_REASON}}</text>
						</view>
						<view class="record-row" wx:if="{{item.RECORD_CHANGE_TIMES}}">
							<text class="record-label">æ¬¡æ•°å˜åŠ¨</text>
							<text class="record-value {{item.RECORD_CHANGE_TIMES > 0 ? 'positive' : 'negative'}}">
								{{item.RECORD_CHANGE_TIMES > 0 ? '+' : ''}}{{item.RECORD_CHANGE_TIMES}}
							</text>
						</view>
						<view class="record-row" wx:if="{{item.RECORD_CHANGE_AMOUNT}}">
							<text class="record-label">ä½™é¢å˜åŠ¨</text>
							<text class="record-value {{item.RECORD_CHANGE_AMOUNT > 0 ? 'positive' : 'negative'}}">
								{{item.RECORD_CHANGE_AMOUNT > 0 ? '+' : ''}}${{item.RECORD_CHANGE_AMOUNT}}
							</text>
						</view>
					</view>
				</view>
				<view wx:else class="empty-records">
					<text class="empty-icon">ğŸ“­</text>
					<text class="empty-text">æš‚æ— ä½¿ç”¨è®°å½•</text>
				</view>
			</scroll-view>
		</view>
	</view>

	<!-- æ·»åŠ å¡é¡¹å¼¹çª— -->
	<view class="modal-overlay" wx:if="{{showAddCardModal}}" bindtap="hideAddCardModal" catchtouchmove="preventTouchMove">
		<view class="modal-container add-card-modal" catchtap="preventClose" catchtouchmove="preventTouchMove">
			<view class="modal-header">
				<text class="modal-title">æ·»åŠ å¡é¡¹</text>
				<text class="modal-close" bindtap="hideAddCardModal">Ã—</text>
			</view>
			<scroll-view class="modal-content" scroll-y>
				<!-- é€‰æ‹©å¡é¡¹ -->
				<view class="form-group">
					<text class="form-label">é€‰æ‹©å¡é¡¹</text>
					<picker mode="selector" range="{{availableCards}}" range-key="CARD_NAME" bindchange="onCardSelect">
						<view class="picker-input">
							<text wx:if="{{selectedCard}}">{{selectedCard.CARD_NAME}}</text>
							<text wx:else class="placeholder">è¯·é€‰æ‹©å¡é¡¹</text>
						</view>
					</picker>
				</view>

				<!-- å¡é¡¹ä¿¡æ¯é¢„è§ˆ -->
				<view wx:if="{{selectedCard}}" class="card-preview">
					<view class="preview-row">
						<text class="preview-label">ç±»å‹</text>
						<text class="preview-value">{{selectedCard.CARD_TYPE === 1 ? 'æ¬¡æ•°å¡' : 'ä½™é¢å¡'}}</text>
					</view>
					<view class="preview-row" wx:if="{{selectedCard.CARD_TYPE === 1}}">
						<text class="preview-label">èµ‹äºˆæ¬¡æ•°</text>
						<text class="preview-value">{{customValue || selectedCard.CARD_TIMES}} æ¬¡</text>
					</view>
					<view class="preview-row" wx:if="{{selectedCard.CARD_TYPE === 2}}">
						<text class="preview-label">èµ‹äºˆé‡‘é¢</text>
						<text class="preview-value">${{customValue || selectedCard.CARD_AMOUNT}}</text>
					</view>
					<view class="preview-row">
						<text class="preview-label">æœ‰æ•ˆæœŸ</text>
						<text class="preview-value">
							{{customValidityDays === '' ? (selectedCard.CARD_VALIDITY_DAYS > 0 ? selectedCard.CARD_VALIDITY_DAYS + ' å¤©' : 'æ°¸ä¹…æœ‰æ•ˆ') : (customValidityDays == 0 || customValidityDays === '' ? 'æ°¸ä¹…æœ‰æ•ˆ' : customValidityDays + ' å¤©')}}
						</text>
					</view>
				</view>

				<!-- è‡ªå®šä¹‰æ¬¡æ•°/é‡‘é¢ -->
				<view wx:if="{{selectedCard}}" class="form-group">
					<text class="form-label">{{selectedCard.CARD_TYPE === 1 ? 'è‡ªå®šä¹‰æ¬¡æ•°' : 'è‡ªå®šä¹‰é‡‘é¢'}}</text>
					<input
						class="form-input"
						type="digit"
						placeholder="{{selectedCard.CARD_TYPE === 1 ? 'è¾“å…¥æ¬¡æ•°ï¼Œé»˜è®¤ä¸º ' + selectedCard.CARD_TIMES : 'è¾“å…¥é‡‘é¢ï¼Œé»˜è®¤ä¸º ' + selectedCard.CARD_AMOUNT}}"
						value="{{customValue}}"
						bindinput="onCustomValueInput"
					/>
				</view>

				<!-- è‡ªå®šä¹‰æœ‰æ•ˆæœŸ -->
				<view wx:if="{{selectedCard}}" class="form-group">
					<text class="form-label">è‡ªå®šä¹‰æœ‰æ•ˆæœŸ (å¤©)</text>
					<input
						class="form-input"
						type="number"
						placeholder="è¾“å…¥å¤©æ•°ï¼Œç•™ç©ºåˆ™æ°¸ä¹…æœ‰æ•ˆ"
						value="{{customValidityDays}}"
						bindinput="onCustomValidityInput"
					/>
					<text class="form-hint">ç•™ç©ºè¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆ</text>
				</view>

				<!-- ç¡®è®¤æŒ‰é’® -->
				<button class="btn-confirm" bindtap="confirmAddCard" disabled="{{!selectedCard}}">
					ç¡®è®¤æ·»åŠ 
				</button>
			</scroll-view>
		</view>
	</view>
</view>
